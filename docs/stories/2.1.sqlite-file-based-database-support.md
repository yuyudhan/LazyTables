# Story 2.1: SQLite File-Based Database Support

## Status
Draft

## Story
**As a** developer working with SQLite databases,
**I want** LazyTables to support file-based SQLite database connections with file browser integration,
**so that** I can open .sqlite/.db files directly and browse them using the familiar six-pane interface.

## Acceptance Criteria

1. File picker integration allows browsing and selecting SQLite database files (.sqlite, .db, .db3 extensions)
2. SQLite-specific metadata display shows file size, table count, and database schema information
3. Support for in-memory databases (:memory:) with appropriate status indicators
4. SQLite PRAGMA command support for database configuration and optimization
5. File path display in connection status with file size and last modified information

## Tasks / Subtasks

- [ ] Task 1: Enhance Connection Modal for SQLite File Selection (AC: 1)
  - [ ] Add file picker mode to ConnectionModalState for SQLite database type
  - [ ] Implement file browser widget for .sqlite, .db, .db3 file selection
  - [ ] Add file path validation and existence checking
  - [ ] Create file selection keyboard navigation (Enter to select, Esc to cancel)
  - [ ] Add support for common SQLite file locations (~/Documents, current directory)

- [ ] Task 2: Enhance SQLite Adapter with File-Specific Features (AC: 2, 3, 5)
  - [ ] Extend existing SQLiteConnection to include file metadata retrieval
  - [ ] Add file size calculation and display in connection info
  - [ ] Implement SQLite database file validation and integrity checking
  - [ ] Add support for in-memory database connections with appropriate metadata
  - [ ] Create SQLite-specific connection string handling for file paths

- [ ] Task 3: SQLite PRAGMA Command Support (AC: 4)
  - [ ] Add PRAGMA command execution to SQLite adapter
  - [ ] Implement common PRAGMA commands (table_info, foreign_key_list, index_list)
  - [ ] Create PRAGMA command autocomplete in query editor for SQLite connections
  - [ ] Add PRAGMA result formatting for better readability
  - [ ] Integrate PRAGMA commands with database capabilities detection

- [ ] Task 4: SQLite-Specific Metadata Display (AC: 2, 5)
  - [ ] Enhance TablesPane to show SQLite-specific metadata (file size, indexes)
  - [ ] Add SQLite database schema information in DetailsPane
  - [ ] Create file information display (path, size, modified date, permissions)
  - [ ] Add SQLite version detection and display
  - [ ] Implement SQLite database statistics (page count, page size, encoding)

- [ ] Task 5: Connection Management Integration (AC: All)
  - [ ] Update ConnectionsPane to display file-based connections with file icons
  - [ ] Add file path truncation for long paths in connection list
  - [ ] Implement connection health checking for file accessibility
  - [ ] Create recent SQLite files list for quick access
  - [ ] Add SQLite file monitoring for external changes

- [ ] Task 6: File Path and Status Integration (AC: 5)
  - [ ] Enhance status bar to show SQLite file path and connection info
  - [ ] Add file size and last modified display in connection status
  - [ ] Create file permission checking and warnings for read-only files
  - [ ] Implement file backup detection and recovery suggestions
  - [ ] Add relative path display for files in current working directory

- [ ] Task 7: Unit Testing (All ACs)
  - [ ] Write unit tests for file picker modal functionality
  - [ ] Write unit tests for SQLite file validation and metadata retrieval
  - [ ] Write unit tests for PRAGMA command execution
  - [ ] Write unit tests for file-based connection management
  - [ ] Write integration tests for SQLite file selection and connection workflow

## Dev Notes

### Previous Story Insights
**Epic 1 Foundation**: Story 1.1 implemented enhanced Connection trait with SQLite adapter supporting basic file connections. Story 1.2 created connection management interface that can be extended for file selection. Story 1.3 established database-adaptive browsing patterns that apply to SQLite file metadata.

**Key Insights from Story 1.1**:
- SQLite adapter already implements enhanced Connection trait with metadata operations
- File path handling exists in build_connection_string() method using database field
- Connection pooling and health checking infrastructure ready for file-based connections

### Data Models
**Source: Current codebase analysis - src/database/sqlite.rs**
- `SqliteConnection` struct with config and pool fields already implemented
- File path handling through `database` field in ConnectionConfig
- Support for :memory: databases already implemented
- SQLite connection string format: `sqlite://{db_path}`

**Source: architecture/data-models.md#Connection**
- `ConnectionConfig` structure supports SQLite database type
- `ConnectionStatus` enum can track file accessibility status
- Local SQLite storage for connection persistence with file path metadata

### Component Specifications
**Source: architecture/components.md#ConnectionsPane + current implementation**
- ConnectionsPane interfaces support connection display and event handling
- Connection modal system exists with step-based workflow
- File system access patterns established in FilesBrowser component

**Current Implementation Context:**
- ConnectionModalState supports database type selection with DatabaseType::SQLite
- File picker functionality needs to be added to existing modal workflow
- Database adapter factory supports SQLite adapter instantiation

### File Locations
**Source: Current project structure analysis**
- SQLite adapter: `src/database/sqlite.rs` (existing, needs file-specific enhancement)
- Connection modal: `src/ui/components/connection_modal.rs` (existing, needs file picker)
- ConnectionsPane: `src/ui/mod.rs` (existing, needs file display enhancement)
- File browser patterns: `src/ui/components/` (FilesBrowser exists for SQL files)

### Technical Constraints
**Source: architecture/tech-stack.md + Epic 1 implementation**
- Use existing SQLx 0.7+ SQLite driver with connection pooling
- Use Ratatui 0.25+ for file picker widget implementation
- Follow established ConnectionModalState patterns for consistency
- Use async file I/O with Tokio for non-blocking file operations
- Maintain vim-style navigation in file picker interface

**SQLite-Specific Requirements:**
- **File Extensions**: Support .sqlite, .db, .db3, .sqlite3 file extensions
- **File Validation**: Check file exists, readable, valid SQLite format
- **PRAGMA Commands**: table_info, foreign_key_list, index_list, database_list, user_version
- **File Metadata**: Size, last modified, permissions, SQLite version, page size
- **Path Handling**: Absolute paths, relative paths, home directory expansion (~/)

### Integration with Epic 1 Foundation
**Story 1.1 Integration**: SQLite adapter implements enhanced Connection trait with all required methods
**Story 1.2 Integration**: Connection modal system provides foundation for file picker workflow
**Story 1.3 Integration**: Database-adaptive browsing patterns apply to SQLite file metadata display

### Testing
**Testing Standards:** Based on Epic 1 patterns and current codebase

**Testing Requirements for this story:**
- Unit tests for file picker modal with keyboard navigation
- Tests for SQLite file validation and error handling
- Integration tests for file selection to database connection workflow
- Tests for PRAGMA command execution and result formatting
- Performance tests for large SQLite file metadata retrieval
- Tests for file monitoring and external change detection

### Project Structure Notes
The existing Epic 1 foundation provides excellent support for SQLite file-based connections:
- Database adapter infrastructure ready for file-specific enhancements
- Connection modal system can accommodate file picker workflow
- Connection management supports file-based connection display

**Enhancement Strategy**: Extend existing SQLite adapter and connection modal rather than creating new components, leverage established patterns from Epic 1 for consistency.

**No structural conflicts identified** - implementation builds on proven Epic 1 foundation.

## Testing

### Testing Standards
**Based on Epic 1 patterns and current codebase:**

- **Test file location**: Tests alongside source files using Rust's built-in test framework
- **Test standards**: Unit tests for component functionality, integration tests for file operations
- **Testing frameworks**: Rust standard test framework with tokio for async testing
- **Specific requirements**:
  - Test file picker modal functionality with keyboard navigation
  - Test SQLite file validation (valid format, permissions, accessibility)
  - Test PRAGMA command execution with different SQLite database versions
  - Test file-based connection management and health checking
  - Test file path display and truncation in connection list
  - Test in-memory database support and status indicators
  - Test file monitoring for external changes and corruption detection

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation for SQLite file-based database support | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*