# Story 2.2: Advanced SQL Query Editor with Syntax Highlighting

## Status
Draft

## Story
**As a** developer writing SQL queries across different database types,
**I want** an advanced query editor with database-specific syntax highlighting and intelligent editing features,
**so that** I can write SQL efficiently with visual feedback for syntax correctness and database-specific keywords.

## Acceptance Criteria

1. Database-specific SQL syntax highlighting adapts automatically based on active connection (PostgreSQL, MySQL, SQLite)
2. Bracket/parentheses matching with visual indicators and automatic closing
3. Query auto-formatting capabilities that format SQL according to database-specific conventions
4. Error highlighting for syntax errors with inline error messages and suggestions
5. Keyword completion based on database type using connection adapter keyword lists

## Tasks / Subtasks

- [ ] Task 1: Implement Database-Aware Syntax Highlighting Engine (AC: 1)
  - [ ] Create SyntaxHighlighter component using syntect crate with SQL language definitions
  - [ ] Implement database-specific highlighting themes for PostgreSQL, MySQL, SQLite keywords
  - [ ] Add dynamic highlighting theme switching based on active database connection
  - [ ] Create keyword highlighting using get_keywords() from database adapters
  - [ ] Add function highlighting using get_functions() from database adapters

- [ ] Task 2: Bracket Matching and Auto-Completion (AC: 2)
  - [ ] Implement bracket/parentheses matching with visual highlighting
  - [ ] Add automatic bracket closing for (, [, {, and quotes
  - [ ] Create bracket pair navigation with vim-style shortcuts (% key)
  - [ ] Add visual indicators for mismatched brackets with error styling
  - [ ] Implement nested bracket level tracking and indentation

- [ ] Task 3: SQL Query Auto-Formatting (AC: 3)
  - [ ] Create SQL formatter with database-specific formatting rules
  - [ ] Implement keyword capitalization based on database conventions
  - [ ] Add proper indentation for nested queries and complex statements
  - [ ] Create formatting shortcuts (Ctrl+Shift+F for format selection/document)
  - [ ] Add configurable formatting preferences (case, indentation, line breaks)

- [ ] Task 4: Error Highlighting and Validation (AC: 4)
  - [ ] Implement real-time syntax error detection using database-specific parsers
  - [ ] Add inline error highlighting with red underlines and error markers
  - [ ] Create error tooltip/status display with specific error messages
  - [ ] Add syntax error recovery suggestions based on database type
  - [ ] Implement error position tracking and cursor navigation to errors

- [ ] Task 5: Intelligent Keyword Completion (AC: 5)
  - [ ] Create autocomplete popup with database-specific keywords and functions
  - [ ] Implement keyword filtering based on typing context and cursor position
  - [ ] Add table name and column name completion using database metadata
  - [ ] Create completion shortcuts (Tab, Enter) and navigation (Up/Down arrows)
  - [ ] Add completion priority based on frequency and context relevance

- [ ] Task 6: Enhanced Query Editor Integration (AC: All)
  - [ ] Enhance existing QueryEditor component from Story 1.4 with syntax highlighting
  - [ ] Integrate with database connection state from ConnectionsPane
  - [ ] Add syntax highlighting state management in AppState
  - [ ] Implement proper editor focus and mode switching with highlighting
  - [ ] Create configuration system for syntax highlighting preferences

- [ ] Task 7: Performance Optimization (AC: All)
  - [ ] Implement efficient syntax highlighting for large SQL files (>100KB)
  - [ ] Add incremental highlighting updates for real-time editing
  - [ ] Create syntax highlighting caching for improved performance
  - [ ] Optimize bracket matching algorithms for complex nested queries
  - [ ] Add performance monitoring for highlighting operations

- [ ] Task 8: Unit Testing (All ACs)
  - [ ] Write unit tests for syntax highlighting engine with different databases
  - [ ] Write unit tests for bracket matching and auto-completion functionality
  - [ ] Write unit tests for SQL formatting with database-specific rules
  - [ ] Write unit tests for error detection and highlighting
  - [ ] Write integration tests for keyword completion with database metadata

## Dev Notes

### Previous Story Insights
**Story 1.4 Foundation**: Implemented multi-database query editor foundation with database-aware features and vim-style navigation. Story 2.2 enhances this foundation with advanced visual and intelligent editing features.

**Story 2.1 Context**: SQLite file-based support adds third major database type requiring syntax highlighting support alongside PostgreSQL and MySQL from Epic 1.

**Key Insights from Story 1.4**:
- Query editor component foundation with database context awareness
- Database adapter integration for query execution and metadata
- Vim-style navigation and text editing patterns established
- Database-specific keyword and function access via Connection trait

### Data Models
**Source: Current codebase analysis - src/database/connection.rs**
- `get_keywords()` and `get_functions()` methods available in Connection trait
- Database adapters provide database-specific keyword and function lists
- `DatabaseCapabilities` structure provides feature detection for syntax highlighting

**Source: architecture/api-specification.md#core-data-structures**
- Database context available through active connection state
- Error handling structures for syntax error reporting
- Query execution context for validation and completion

### Component Specifications
**Source: architecture/tech-stack.md#technology-stack-table + Story 1.4**
- Syntect 5.0+ for SQL syntax highlighting in terminal
- Custom text buffer with vim motions from QueryEditor component
- Integration with StateManager for application-wide query editor state
- Ratatui text widgets for editor rendering with styled text support

**Current Implementation Context:**
- QueryEditor component from Story 1.4 provides foundation for enhancement
- Database connection context available through application state
- Query execution and file management systems already integrated

### File Locations
**Source: Story 1.4 implementation + Epic 2 requirements**
- Query editor component: `src/ui/components/query_editor.rs` (from Story 1.4)
- Syntax highlighting engine: `src/editor/syntax.rs` (to be created)
- SQL formatter: `src/editor/formatter.rs` (to be created)
- Editor state management: `src/app/state.rs` (existing, needs syntax state)
- Configuration: `src/config/editor.rs` (to be created for preferences)

### Technical Constraints
**Source: architecture/tech-stack.md + Epic 2 requirements**
- Use syntect 5.0+ for terminal-compatible syntax highlighting
- Maintain vim-style navigation patterns from existing editor
- Use existing database adapter keyword/function methods
- Follow async patterns for non-blocking syntax highlighting
- Preserve existing query execution and file management functionality

**Database-Specific Highlighting Requirements:**
- **PostgreSQL**: JSONB, ARRAY, SERIAL, BIGSERIAL, SCHEMA, ::casting, $1 parameters
- **MySQL**: AUTO_INCREMENT, ENGINE, CHARSET, COLLATE, UNSIGNED, backtick identifiers
- **SQLite**: PRAGMA, AUTOINCREMENT, sqlite_master, WITHOUT ROWID, ON CONFLICT
- **Common SQL**: SELECT, FROM, WHERE, JOIN, INSERT, UPDATE, DELETE, CREATE, ALTER, DROP
- **Functions**: Database-specific functions from get_functions() method

### Syntax Highlighting Architecture
**Integration with Story 1.4 QueryEditor:**
- Extend existing text buffer with syntax highlighting capabilities
- Add real-time highlighting updates during text editing
- Integrate with database connection state for dynamic theme switching
- Preserve vim navigation and editing modes with highlighted text

**Performance Considerations:**
- Incremental highlighting for large files
- Syntax highlighting caching for frequently edited queries
- Background processing for complex highlighting operations
- Memory-efficient highlighting for long query sessions

### Testing
**Testing Standards:** Based on Epic 1/Story 1.4 patterns and current codebase

**Testing Requirements for this story:**
- Unit tests for syntax highlighting engine with all database types
- Performance tests for highlighting large SQL files (>100KB)
- Tests for bracket matching with complex nested queries
- Integration tests for keyword completion with database metadata
- Tests for error highlighting and syntax validation
- Tests for SQL formatting with different database conventions
- Visual regression tests for highlighting appearance

### Project Structure Notes
The existing Story 1.4 QueryEditor provides excellent foundation for syntax highlighting enhancement:
- Database context awareness already implemented
- Vim-style text editing and navigation established
- Integration with database adapters and query execution ready
- State management and configuration patterns available

**Enhancement Strategy**: Extend Story 1.4 QueryEditor with syntax highlighting capabilities rather than creating new component, add syntax engine as separate module, integrate with existing database adapter keyword/function methods.

**No structural conflicts identified** - implementation enhances proven Story 1.4 foundation.

## Testing

### Testing Standards
**Based on Story 1.4 patterns and Epic 1 foundation:**

- **Test file location**: Tests alongside source files using Rust's built-in test framework
- **Test standards**: Unit tests for highlighting engine, integration tests for editor features
- **Testing frameworks**: Rust standard test framework with tokio for async operations
- **Specific requirements**:
  - Test syntax highlighting accuracy for PostgreSQL, MySQL, SQLite keywords
  - Test bracket matching with deeply nested queries and complex statements
  - Test SQL formatting output for database-specific conventions
  - Test error highlighting with various syntax error scenarios
  - Test keyword completion with real database metadata
  - Test performance with large SQL files and complex highlighting
  - Test integration with existing vim navigation and editing modes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation for advanced SQL query editor with syntax highlighting | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*